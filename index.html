<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>فاحص قوة كلمة المرور — مع تعزيز</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: "Tahoma", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #0073b1;
      color: #000;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: #fff;
      text-align: center;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      color: #000;
      border: 2px solid #000;
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
    }

    .container {
      background: #fff;
      padding: 18px 22px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      width: 380px;
      margin: 24px auto;
      text-align: center;
    }

    .password-wrapper {
      position: relative;
      width: 100%;
      margin: 12px 0;
    }
    .password-wrapper input {
      width: 100%;
      padding: 10px 40px 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
      box-sizing: border-box;
      direction: rtl;
      text-align: right;
    }
    .toggle-btn {
      position: absolute;
      top: 50%;
      left: 12px;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 16px;
      color: #555;
    }

    .progress-container {
      width: 100%;
      background: #eee;
      border-radius: 8px;
      margin-top: 8px;
      height: 12px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: red;
      transition: width 0.35s ease;
    }

    .strength {
      font-weight: bold;
      margin-top: 10px;
      padding: 6px;
      border-radius: 8px;
      font-size: 14px;
    }

    .tips { margin-top: 8px; font-size: 13px; color:#333; text-align:right; }

    .info { margin-top: 12px; text-align:right; font-size:14px; }
    .info strong{ display:block; color:#004080; margin-top:8px; }
    .result-text{ font-weight:700; color:#000; margin-right:10px; }

    .actions { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    button {
      padding:10px 14px;
      border-radius:8px;
      border:none;
      background:linear-gradient(90deg,#0073b1,#00a8e8);
      color:#fff;
      cursor:pointer;
      font-size:14px;
    }
    button.secondary { background:#555; }

    footer {
      margin-top:auto;
      background:#fff;
      padding:12px;
      border-top:2px solid #0073b1;
      text-align:center;
    }
    footer div { display:inline-block; border:2px solid #0073b1; padding:8px 14px; border-radius:8px; color:#004080; font-weight:700; margin:4px; }
  </style>
</head>
<body>
  <header>
    <h1>فاحص قوة كلمة المرور</h1>
  </header>

  <div class="container">
    <div class="password-wrapper">
      <input id="password" type="password" placeholder="أدخل كلمة المرور">
      <i id="toggleIcon" class="fa-solid fa-eye toggle-btn" onclick="togglePassword()"></i>
    </div>

    <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
    <div id="result" class="strength">الرجاء إدخال كلمة المرور</div>
    <div id="tips" class="tips"></div>

    <div class="info">
      <strong>التحقق من الاختراق:</strong>
      <div class="result-text" id="pwned">-</div>

      <strong>التحقق من إعادة الاستخدام (محلياً):</strong>
      <div class="result-text" id="reuse">-</div>

      <strong>تحذير:</strong>
      <div class="result-text" id="warning">-</div>
    </div>

    <div class="actions">
      <button id="checkBtn">🔍 فحص الكلمة</button>
      <button id="generateBtn">⚡ توليد / تعزيز</button>
      <button id="saveBtn" class="secondary">💾 حفظ محلياً</button>
      <button id="clearBtn" class="secondary">🗑️ مسح المحفوظ</button>
    </div>
  </div>

  <footer>
    <div>الطالب نايف العنزي</div>
    <div>الطالب عبدالعزيز العقيل</div>
  </footer>

  <script>
    // ---------- مساعدة: توليد حرف/رمز عشوائي ----------
    function randomChar() {
      const pool = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()-_=+[]{};:,.<>?";
      return pool.charAt(Math.floor(Math.random() * pool.length));
    }

    // ---------- توليد كلمة عشوائية كاملة ----------
    function generateRandomPassword(length = 14) {
      const pool = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()-_=+[]{}<>?";
      let p = "";
      const cryptoArr = new Uint32Array(length);
      window.crypto.getRandomValues(cryptoArr);
      for (let i=0;i<length;i++){
        p += pool[cryptoArr[i] % pool.length];
      }
      return p;
    }

    // ---------- تعزيز كلمة المستخدم ----------
    // سلوك: إذا الحقل فيه نص -> 50% يضيف '@' في النهاية، 50% يضيف حرف/رقم/رمز عشوائي
    function enhanceUserPassword(pw) {
      if (!pw) return generateRandomPassword(14);
      if (Math.random() < 0.5) {
        // إذا لم يحتوي على '@' مسبقاً نضيفه، إذا كان موجود نضيف رمز عشوائي
        return pw.includes('@') ? pw + randomChar() : pw + '@';
      } else {
        return pw + randomChar();
      }
    }

    // ---------- إظهار/إخفاء كلمة المرور ----------
    function togglePassword() {
      const pw = document.getElementById('password');
      const icon = document.getElementById('toggleIcon');
      if (pw.type === 'password') {
        pw.type = 'text'; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash');
      } else {
        pw.type = 'password'; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye');
      }
    }

    // ---------- فحص القوة + تحديث الواجهة ----------
    function updateStrengthUI(password) {
      const result = document.getElementById('result');
      const tips = document.getElementById('tips');
      const progress = document.getElementById('progressBar');
      const warning = document.getElementById('warning');

      let score = 0;
      let suggestions = [];

      if (password.length >= 8) score++; else suggestions.push("🔹 استخدم 8 أحرف على الأقل");
      if (/[A-Z]/.test(password)) score++; else suggestions.push("🔹 أضف حرف كبير (A-Z)");
      if (/[0-9]/.test(password)) score++; else suggestions.push("🔹 أضف أرقام");
      if (/[^A-Za-z0-9]/.test(password)) score++; else suggestions.push("🔹 أضف رموز خاصة مثل !@#$");

      const percent = (score / 4) * 100;
      progress.style.width = percent + "%";
      progress.style.background = score <= 1 ? "red" : score === 2 ? "orange" : "green";

      if (!password) {
        result.textContent = "الرجاء إدخال كلمة المرور";
        result.className = "strength";
        tips.innerHTML = "";
        warning.textContent = "-";
      } else if (score <= 1) {
        result.textContent = "ضعيفة";
        result.className = "strength weak";
        tips.innerHTML = suggestions.join("<br>");
        warning.textContent = "⚠️ ضعيفة — حسّنها بإضافة طول/حروف/رموز";
      } else if (score === 2) {
        result.textContent = "متوسطة";
        result.className = "strength";
        tips.innerHTML = suggestions.join("<br>");
        warning.textContent = "⚠️ متوسطة — يمكنك جعلها أقوى";
      } else {
        result.textContent = "قوية";
        result.className = "strength";
        tips.innerHTML = "✅ كلمة المرور جيدة. لزيادة الأمان اجعلها أطول.";
        warning.textContent = "✅ قوية";
      }
    }

    // ---------- تجزئة SHA-1 و SHA-256 ----------
    async function sha1Hex(str) {
      const buf = await crypto.subtle.digest("SHA-1", new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('').toUpperCase();
    }
    async function sha256Hex(str) {
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // ---------- فحص تسريبات عبر HIBP (k-anonymity) ----------
    async function checkPwned(password) {
      if (!password) return "-";
      try {
        const sha1 = await sha1Hex(password);
        const prefix = sha1.slice(0,5);
        const suffix = sha1.slice(5);
        const resp = await fetch(`https://api.pwnedpasswords.com/range/${prefix}`);
        if (!resp.ok) throw new Error('network');
        const text = await resp.text();
        const lines = text.split('\n');
        for (const line of lines) {
          const [hash,count] = line.trim().split(':');
          if (hash === suffix) return `⚠️ تم العثور عليها ${count} مرة في التسريبات!`;
        }
        return '✅ غير موجودة في التسريبات';
      } catch (e) {
        return '⚠️ خطأ بالتحقق (لا اتصال)';
      }
    }

    // ---------- سجل محلي (بصمات SHA-256) ----------
    const KEY = 'pw_checker_history';
    function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY))||[] }catch{ return [] } }
    function saveHistory(arr){ localStorage.setItem(KEY, JSON.stringify(arr)) }
    async function checkReuse(password){ if(!password) return false; const h = await sha256Hex(password); return loadHistory().includes(h); }

    // ---------- روابط الأزرار ----------
    document.getElementById('checkBtn').addEventListener('click', async ()=>{
      const pw = document.getElementById('password').value;
      updateStrengthUI(pw);
      document.getElementById('pwned').textContent = '⏳ جاري التحقق...';
      document.getElementById('reuse').textContent = '⏳ جاري التحقق...';

      const pwned = await checkPwned(pw);
      document.getElementById('pwned').textContent = pwned;

      const reused = await checkReuse(pw);
      document.getElementById('reuse').textContent = reused ? '⚠️ كلمة المرور هذه استُخدمت سابقاً (محلياً)' : '✅ لم تُستخدم محلياً';
    });

    // الزر المعدل: يولد إذا الحقل فاضي، وإلا يعزز نفس الكلمة (يضيف @ أو حرف عشوائي)
    document.getElementById('generateBtn').addEventListener('click', ()=>{
      const input = document.getElementById('password');
      const current = input.value.trim();
      let newPass;
      if (!current) {
        newPass = generateRandomPassword(14);
      } else {
        newPass = enhanceUserPassword(current);
      }
      input.value = newPass;
      updateStrengthUI(newPass);
      // نترك فحص التسريبات والحفظ للمستخدم (زر الفحص/حفظ) لخصوصية أفضل
    });

    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      const pw = document.getElementById('password').value;
      if (!pw) { alert('أدخل كلمة المرور أولاً'); return; }
      const h = await sha256Hex(pw);
      const arr = loadHistory();
      if (!arr.includes(h)) arr.push(h);
      saveHistory(arr);
      alert('تم حفظ كلمة المرور (بصمة مشفرة) محلياً.');
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      localStorage.removeItem(KEY);
      alert('تم مسح السجل المحلي.');
    });

    // فحص تلقائي أثناء الكتابة (خفة واجهة)
    let debounce;
    document.getElementById('password').addEventListener('input', e=>{
      clearTimeout(debounce);
      debounce = setTimeout(()=> updateStrengthUI(e.target.value), 220);
    });
  </script>
</body>
</html>
